# This transport is used for handling file addresses generated by alias
# or .forward files if the path ends in "/", which causes it to be treated
# as a directory name rather than a file name.

address_directory:
  debug_print = "T: address_directory for $local_part@$domain"
  driver = appendfile
  envelope_to_add
  return_path_add
  # This is enabled by default, but just to be explicit..
  create_directory
  check_string = ""
  escape_string = ""
  allow_symlink
  maildir_format
  maildir_use_size_file
  # 
  # Work out if this is a symbiosis domain
  # and See if a per-domain quota has been set.
  #  a) Use the per-user quota if set
  #  b) Use the per-domain quota if set
  #  c) Use a zero quota
  #
  # We then sanity check it to make sure that we're using the specified format.
  #
  # NB The Exim manual says that the multiplier can only be K,M, or G.  Dovecot
  # wants k, M, or G.  Having had a look at the exim4 source, the comparison is
  # done after making the multiplier lowercase, so we can specify k, M, or G.
  #
  # See line 301 of src/transports/appendfile.c in v4.72.
  #
  quota = ${if match{ \
            ${if exists{VHOST_DIR/${domain}/VHOST_MAILBOX_DIR/${local_part}/quota} \ 
              {${readfile{VHOST_DIR/${domain}/VHOST_MAILBOX_DIR/${local_part}/quota}}} \
              { \
                ${if exists{VHOST_DIR/${domain}/VHOST_CONFIG_DIR/default_mailbox_quota} \
                  {${readfile{VHOST_DIR/${domain}/VHOST_CONFIG_DIR/default_mailbox_quota}}} \
                  {0} \
                } \
              } \
            } \
          }{\N\b(\d+[kMG]?)\b\N}{$1}{0}}

