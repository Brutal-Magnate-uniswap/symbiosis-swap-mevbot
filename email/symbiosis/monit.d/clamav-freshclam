#!/usr/bin/ruby1.8 

require 'symbiosis/monitor/check'

class FreshclamCheck < Symbiosis::Monitor::Check

  def initialize
    super
    @process.pidfile = "/var/run/clamav/freshclam.pid"
    @process.initscript = "/etc/init.d/clamav-freshclam"
    @name = "freshclam"
  end

  def do_check
    return SystemExit::EX_CONFIG unless initscript_ok?

    r = do_process_check
    if SystemExit::EX_TEMPFAIL == r 
      should_be_running ? self.start : self.stop
    end
    return r
  end

  def should_be_running
    (0 < Dir.glob('/srv/*/config/antivirus').length)
  end

  #
  # Ignore the test if 
  #   * dpkg if running 
  #   * the initscript is missing and freshclam should not be running.
  #
  def should_ignore?
    self.class.dpkg_running? or
      (not File.exists?(@process.initscript) and not should_be_running)
  end

end

exit FreshclamCheck.new.do_check if $0 == __FILE__

