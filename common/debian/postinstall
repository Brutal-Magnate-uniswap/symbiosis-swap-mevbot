#!/bin/sh
#
#  This script has the task of performing the "common" post-install
# setup for all the Symbiosis packages.
#
#  It shouldn't do anything too package-specific, as that is a task
# for the specific packages, but global actions are good.
#
#
# Steve
# --
#



set -e



#
# Skip, if we are not in "configure" state
#
if [ "$1" != "configure" ]; then
        echo "I: Skipping configuration"
        exit 0
fi



#
#  Shadow passwords must be on.
#
/sbin/shadowconfig on 2>/dev/null >/dev/null



#
#  If there isn't an admin account add it.
#
if ( ! grep ^admin: /etc/passwd 2>/dev/null >/dev/null ); then

    echo "Adding 'admin' account"
    useradd  --home=/srv admin --shell=/bin/bash

    #
    #  Now set the password for admin to that used by root if it isn't there
    #
    usermod -p $(grep root /etc/shadow | awk -F: '{print $2}') admin
fi


#
#  Add group if missing
#
if ( ! grep ^admin: /etc/group 2>/dev/null >/dev/null ); then
    addgroup admin
fi


#
#  If we don't have the sudoers file setup then configure it
#
if [ -e /etc/sudoers ]; then

    #
    #  Not already present?
    #
    if ( ! grep ^admin /etc/sudoers 2>/dev/null >/dev/null ); then

        #
        #  Add it.
        #
        echo 'admin ALL = (ALL) ALL' >> /etc/sudoers
    fi
fi


#
#  If there are no existing directories beneath /srv/ create a default.
#
if [ $(ls -l /srv/ | grep ^d | wc -l) -lt 1 ] ; then

    #
    #  Roots
    #
    mkdir -p /srv/$(hostname --fqdn)/public/htdocs
    mkdir -p /srv/$(hostname --fqdn)/public/cgi-bin
    mkdir -p /srv/$(hostname --fqdn)/mailboxes/root

    #
    #  Copy the password if present
    #
    for i in /etc/bytemark-vhost/ /etc/ ; do
        if [ -e $i/.vhost.pass ]; then
            cat $i/.vhost.pass > /srv/$(hostname --fqdn)/mailboxes/root/password

            #
            #  This is a migration to make sure we store the
            # password somewhere safe
            #
            if [ ! -d /etc/symbiosis ]; then
                mkdir -p /etc/symbiosis
            fi
            cat $i/.vhost.pass > /etc/symbiosis/.passwd

        fi
    done

    chown -R admin:admin /srv/
fi


#
#  Remove any existing sites.
#
for i in mass-hosting mass-hosting.ssl zz-mass-hosting zz-mass-hosting.ssl default 00-default ; do
    if [ -e /etc/apache2/sites-enabled/$i ]; then
        rm /etc/apache2/sites-enabled/$i
    fi
done

#
#  Find IP address of the first interfaces
#
ip=$(ifconfig  eth0 | grep 'inet addr' | awk -F: '{print $2}' | awk '{print $1}' )


#
#  Create the mass-hosting configuration file
#
cat > /etc/apache2/sites-available/zz-mass-hosting <<EOF

####
##
#
# DO NOT EDIT THIS FILE - CHANGES WILL BE OVERWRITTEN
#
#  This file is automatically generated.
#
#  http://symbiosis.bytemark.co.uk/docs/ch-webreference.html
#
##
###

NameVirtualHost $ip:80

<VirtualHost $ip:80>

        #
        #  This is the directory people are redirected to
        # if their site is empty.
        #
        Alias /bytemark/ "/usr/share/symbiosis-static/"
        <Directory "/usr/share/symbiosis-static/">
                DirectoryIndex index.html index.php
                AllowOverride All
        </Directory>


        #
        #  And this makes that redirection happen.
        #
        <LocationMatch "^/+$">
                Options -Indexes
                ErrorDocument 403 /bytemark/
        </LocationMatch>


        #
        #  Allow users to override settings via .htaccess
        #
        <Directory "/srv">
                AllowOverride all
        </Directory>


        #
        #  We will allow global CGIs without any effort though.
        #
        AddHandler cgi-script .cgi


        #
        #  Disable the "single" name for this server.
        #
        UseCanonicalName        Off


        #
        #  Aliases for testing sites prior to DNS migration.
        #
        RewriteEngine On
        RewriteCond %{HTTP_HOST} ^(.*)\.testing\.(.*)\$
        RewriteRule ^/(.*)\$  /srv/%1/public/htdocs/\$1


        #
        #  The document root + CGI-directories.
        #
        VirtualDocumentRoot     /srv/%0/public/htdocs/
        VirtualScriptAlias      /srv/%0/public/cgi-bin/


        #
        # Update documentroot settings for each vhost.
        #
        SetVirtualDocumentRoot on

        #
        #  We need to log the virtual hostname the incoming request was
        # made against, so that the cron-job in /etc/cron.daily may generate
        # statistics for each domain.
        #
        CustomLog /var/log/apache2/access.log "%V %h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-agent}i\""
</VirtualHost>


EOF


cat > /etc/apache2/sites-available/zz-mass-hosting.ssl <<EOF

####
##
#
# DO NOT EDIT THIS FILE - CHANGES WILL BE OVERWRITTEN
#
#  This file is automatically generated.
#
#  http://vhost.bytemark.co.uk/docs/ch-webreference.html
#
##
###


#DEBHELPER#
exit 0
